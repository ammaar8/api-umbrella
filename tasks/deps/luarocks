#!/usr/bin/env bash

luarocks_version="3.12.0"
luarocks_hash="3d4c8acddf9b975e77da68cbf748d5baf483d0b6e9d703a844882db25dd61cdf"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "https://luarocks.github.io/luarocks/releases/luarocks-$luarocks_version.tar.gz" "sha256" "$luarocks_hash"
extract_download "luarocks-$luarocks_version.tar.gz"

cd "luarocks-$luarocks_version"
./configure \
  --prefix="$INSTALL_PREFIX_EMBEDDED/openresty/luajit" \
  --with-lua="$STAGE_EMBEDDED_DIR/openresty/luajit"
make
# Clean old installations on version upgrades.
rm -rf "$STAGE_DIR$INSTALL_PREFIX_EMBEDDED/openresty/luajit/share/lua/5.1/luarocks" \
  "$STAGE_DIR$INSTALL_PREFIX_EMBEDDED/openresty/luajit/bin/luarocks"* \
  "$STAGE_DIR$INSTALL_PREFIX_EMBEDDED/openresty/luajit/etc/luarocks"
make install DESTDIR="$STAGE_DIR"
(cd "$STAGE_EMBEDDED_DIR/bin" && ln -snf ../openresty/luajit/bin/luarocks ./luarocks)

stamp
